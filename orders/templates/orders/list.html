{% extends "base.html" %}
{% load static %}


{% block content %}
<h1>Orders</h1>
<div class="orders table-responsive">
    <table id="data_table" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Pedido #</th>
                <th>Cliente</th>
                <th>Empresa</th>
                <th>Total</th>
                <th>Creado</th>
                <th>Modificado</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
{% endblock %}

{% block javascript %}

<script type="text/javascript">
    $(document).ready(function () {
        $('#data_table').DataTable({
            responsive: true,
            autoWidth: true,
            destroy: true,
            deferRender: true,
            processing: true,
            order: [[4, 'desc']],
            ajax: {
                url: '/orders/list/json',
                type: 'GET',
                data: {},
                dataSrc: "",
            },
            columns: [
                { 'data': 'id' },
                { 'data': 'billing' },
                { 'data': 'billing' },
                { 'data': 'total' },
                { 'data': 'date_created' },
                { 'data': 'date_modified' },
                { 'data': 'status' },
                { 'data': 'id' }
            ],
            columnDefs: [
                {
                    targets: [-1],
                    class: 'text-center',
                    orderable: false,
                    render: function (data, type, row) {
                        url = `http://cmoyano.pythonanywhere.com/orders/${row.id}/pdf`;
                        text = `Hola ${row.billing.first_name}! \n En el siguiente link puedes descargar tu pedido: ${url} \n Gracias por tu compra en Jugaso.com`;
                        let buttons = "<a class='btn btn-dark btn-sm' href='/orders/" + row.id + "/pdf' target='_blank'>Generar PDF</a>";
                        buttons += `<a class='btn btn-success btn-sm' href='whatsapp://send?text=${text}' data-action='share/whatsapp/share'>Compartir via Whatsapp</a>`;
                        // buttons += "<a class='btn btn-primary btn-sm' href='/orders/" + row.id + "'><i class='fas fa-eye'></i></a>";
                        return buttons;
                    },
                },
                {
                    targets: [-2],
                    class: 'text-center',
                    orderable: true,
                    render: function (data, type, row) {
                        let status = '';
                        switch (row.status) {
                            case 'on-hold':
                                status = 'En espera';
                                classTxt = 'bg-warning';
                                break;
                            case 'completed':
                                status = 'Completado';
                                classTxt = 'bg-primary';
                                break;
                            case 'pending':
                                status = 'Pendiente de pago';
                                classTxt = 'bg-danger';
                                break;
                            case 'processing':
                                status = 'Procesando';
                                classTxt = 'bg-info';
                                break;
                            case 'canceled':
                                status = 'Cancelado';
                                classTxt = 'bg-dark';
                                break;
                            case 'refunded':
                                status = 'Reembolsado';
                                classTxt = 'bg-dark';
                                break;
                            default:
                                status = row.status;
                        }
                        return `<span class='badge ${classTxt} fs-6'>${status}</span>`;
                    },
                },
                {
                    targets: [-5],
                    class: 'text-center',
                    orderable: true,
                    render: function (data, type, row) {
                        return `<span class='fw-semibold'>$ ${row.total}</span>`;
                    },
                },
                {
                    targets: [-6],
                    class: 'text-center',
                    orderable: true,
                    render: function (data, type, row) {
                        return `${row.billing.company}`;
                    },
                },
                {
                    targets: [-7],
                    class: 'text-center',
                    orderable: true,
                    render: function (data, type, row) {
                        return `${row.billing.first_name} ${row.billing.last_name}`;
                    },
                }

            ],
            initComplete: function (settings, json) {

            },
            /* Results in:
                {B: Buttons}
                {l: input length}
                {f: input filter}
                {r: processing}
                {t: table}
                {i: table information}
                {p: pagination}
            */
            dom: 'B<f<t>ipl>',
            language: {
                url: "/static/vendoors/DataTables/spanish.json"
            },
        });
    });
</script>
{% endblock javascript %}